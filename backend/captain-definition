{
  "schemaVersion": 2,
  "dockerfileLines": [
    "FROM python:3.12-slim",
    "",
    "# Vari√°veis de ambiente",
    "ENV PYTHONUNBUFFERED=1",
    "ENV PYTHONDONTWRITEBYTECODE=1",
    "ENV ENVIRONMENT=production",
    "",
    "# Instalar depend√™ncias do sistema",
    "RUN apt-get update && apt-get install -y \\",
    "    gcc \\",
    "    postgresql-client \\",
    "    supervisor \\",
    "    && rm -rf /var/lib/apt/lists/*",
    "",
    "# Criar diret√≥rio de trabalho",
    "WORKDIR /app",
    "",
    "# Copiar requirements e instalar depend√™ncias Python",
    "COPY requirements.txt /app/",
    "RUN pip install --no-cache-dir --upgrade pip && \\",
    "    pip install --no-cache-dir -r requirements.txt && \\",
    "    pip install --no-cache-dir gunicorn",
    "",
    "# Copiar c√≥digo da aplica√ß√£o",
    "COPY . /app/",
    "",
    "# Coletar arquivos est√°ticos (usar development durante build)",
    "RUN ENVIRONMENT=development python manage.py collectstatic --noinput || true",
    "",
    "# Expor porta",
    "EXPOSE 80",
    "",
    "# Configurar supervisor para gerenciar Gunicorn + Celery",
    "RUN mkdir -p /etc/supervisor/conf.d",
    "",
    "# Script de inicializa√ß√£o que aplica migrations e inicia supervisor",
    "RUN echo '#!/bin/bash\\nset -e\\n\\n# Aplicar migrations\\necho \"üì¶ Aplicando migrations...\"\\npython manage.py migrate --noinput\\necho \"‚úÖ Migrations aplicadas\"\\n\\n# Verificar se deve rodar Celery no mesmo container\\nCELERY_MODE=${CELERY_MODE:-same}\\n\\nif [ \"$CELERY_MODE\" = \"separate\" ]; then\\n    # Modo separado: apenas Gunicorn (para quando tiver servi√ßo Celery separado)\\n    echo \"üöÄ Modo separado: Iniciando apenas Gunicorn...\"\\n    exec gunicorn --bind 0.0.0.0:80 --workers 3 --timeout 120 --access-logfile - --error-logfile - config.wsgi:application\\nelse\\n    # Modo mesmo container: Supervisor gerencia Gunicorn + Celery\\n    echo \"üöÄ Modo mesmo container: Iniciando Gunicorn + Celery Worker...\"\\n    exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf\\nfi' > /app/start.sh && chmod +x /app/start.sh",
    "",
    "# Configura√ß√£o do Supervisor (Gunicorn + Celery)",
    "RUN echo '[supervisord]\\nnodaemon=true\\n\\n[program:gunicorn]\\ncommand=gunicorn --bind 0.0.0.0:80 --workers 3 --timeout 120 --access-logfile - --error-logfile - config.wsgi:application\\ndirectory=/app\\nautostart=true\\nautorestart=true\\nstderr_logfile=/dev/stderr\\nstderr_logfile_maxbytes=0\\nstdout_logfile=/dev/stdout\\nstdout_logfile_maxbytes=0\\n\\n[program:celery]\\ncommand=celery -A config worker -l info\\ndirectory=/app\\nautostart=true\\nautorestart=true\\nstderr_logfile=/dev/stderr\\nstderr_logfile_maxbytes=0\\nstdout_logfile=/dev/stdout\\nstdout_logfile_maxbytes=0' > /etc/supervisor/conf.d/supervisord.conf",
    "",
    "# Comando para iniciar aplica√ß√£o (executa migrations antes)",
    "CMD [\"/app/start.sh\"]"
  ]
}

